---
title: "results joint experiment"
output:
  html_document:
    df_print: paged
---

Load data

```{r, warning=FALSE, message=FALSE}
library(here)
library(ggforce)
source(here("R", "analysis-utils.R"))
```

```{r, data}
result_dir = here("data", "formatted-all")
DATA = load_formatted_data(result_dir)
```

## Meta info about participants

```{r, meta, echo=FALSE}
df <- DATA$info %>% group_by(prolific_id) %>% distinct() %>%
  mutate(education=as_factor(education), gender=as_factor(gender))
p <- df %>%
  ggplot(aes(x=factor(0), y=timeSpent)) + 
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(shape=16, width=0.2) +
  theme(legend.position="none") +
  labs(x = "", y="timeSpent in min.") +
  geom_hline(aes(yintercept = mean(df$timeSpent)), color="green")

p
df %>% ungroup() %>%  group_by(prolific_id) %>%  summary()
```

```{r}
df %>% filter(timeSpent < 20)
```


## Reaction Times per stimulus

```{r, reaction-times, echo=FALSE}
df <- DATA$production %>% dplyr::select(prolific_id, id, RT) %>% group_by(id) %>%
  distinct()

TRIALS = df$id %>% unique()

dat.RT = df %>% group_by(id) %>% summarise(mu=mean(RT), sd=sd(RT), .groups="drop_last")
df <- left_join(df, dat.RT, by="id")
for(pa in seq(1,2)) {
  p <- df %>%  
    ggplot(aes(y=RT)) + geom_boxplot(outlier.shape = NA) +
    geom_jitter(aes(x=0, color=prolific_id), width = 0.1, alpha = 0.5) +
    geom_hline(aes(yintercept = mu), color="green", linetype="dashed") +
    theme(legend.position="right", axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
    labs(x="", y="RT in ms", title="Reaction Times per stimulus") +
    facet_wrap_paginate(~id, nrow=2, ncol=5, page=pa) +
    scale_y_continuous(trans = log2_trans(),
                       breaks = trans_breaks("log2", function(x) 2^x),
                       labels = trans_format("log2", math_format(2^.x))) +
    theme(legend.position="none")
  print(p)
}
```

# General comments all participants

```{r, echo=FALSE}
dat.tidy <- readRDS(paste(result_dir, "tidy_data.rds", sep = FS))
```

```{r}
df.comments = dat.tidy$comments %>% filter(!is.na(comments) & comments!="")
print(df.comments$comments)
```

After looking at comments, save which participants must be excluded due to 
what they said.

```{r}
out.comments = df.comments %>%
  filter(comments == "I apologize because the first couple of graphics did not appear properly, so I picked any answer. The rest of the study went fine." |
         comments == "The descriptions on this quiz were terrible and confusing. Non native English speakers will have a lot of trouble." |
         comments == "This was hard to understand")

# time they spent on experiment
out.comments_time = 
  left_join(DATA$info %>% filter(prolific_id %in% out.comments$prolific_id),
            out.comments, 
            by = "prolific_id")
out.comments_time

out.comments = out.comments_time %>% dplyr::select(prolific_id)
# remove all trials for these participants
df.out = out.comments %>% 
  add_column(id = rep(list(TRIALS), nrow(out.comments))) %>%
  unnest(c(id)) %>%
  group_by(prolific_id)

# write_csv(df.out, here("data", "out_by_comments.csv"))
```


# Color vision trials all participants

```{r, color-vision, echo=FALSE}
df <- dat.tidy$color %>% group_by(prolific_id, id) %>%
  mutate(correct = expected == response)

df %>%
  ggplot(aes(x=id)) + geom_bar(position="dodge", aes(fill=correct)) +
  theme(axis.text.x = element_text(angle=90, hjust=1), legend.position = "top")
pids.false_colors = df %>% filter(correct == FALSE)  %>% pull(prolific_id) 
```

Attention check questions

```{r}
df.att = dat.tidy$train.attention %>% filter(response != expected) 
df.att
```



## Production Task
Custom responses

```{r, custom-responses, fig.height = 10, fig.width = 10}
dat.custom = DATA$production %>% filter(!is.na(custom_response)) %>% 
  mutate(custom_response = tolower(custom_response))

total = DATA$production %>% dplyr::select(prolific_id, id) %>% distinct()
print(paste('nb total custom responses given:', nrow(dat.custom), 'out of', 
            nrow(total), '(', nrow(dat.custom) / nrow(total), ')'))
# exactly the same custom response as selected response
dat.custom_different = dat.custom %>% 
  filter(response_non_standardized != tolower(custom_response)) %>% 
  dplyr::select(prolific_id, id, custom_response, response_non_standardized, 
                response) %>% group_by(custom_response) %>% 
  mutate(id = str_replace(id, "independent", "ind")) %>% 
  mutate(n = n()) 

write_csv(dat.custom_different %>% dplyr::select(-prolific_id, -response), 
          paste(result_dir, "custom_responses.csv", sep = FS))

plot_custom_responses = function(df) {
  p <- df %>% 
    ggplot(aes(x = n, y = fct_rev(fct_infreq(custom_response)))) +
    geom_bar(stat = "identity", position = position_dodge()) +
    theme(text = element_text(size=20),
          axis.text.x=element_text(angle=45, vjust = 0.5)) +
    facet_wrap(~id, scales="free_x", ncol = 3) +
    labs(x="count", y="custom response", title="custom responses")
  return(p)
}
plot_custom_responses(dat.custom_different %>% filter(n > 1)) 
dat.custom_different %>% filter(n == 1)

```

For each stimulus, which response was created how often?

```{r, echo=FALSE, fig.height = 12}
df.production.means = DATA$production %>%
  dplyr::select(id, response, prolific_id) %>% 
  group_by(id,response) %>% 
  mutate(n=n()) %>% group_by(id) %>% mutate(N=n(), ratio=n/N) %>%
  arrange(desc(ratio)) %>% 
  add_column(predictor="empirical")

df = df.production.means %>% dplyr::select(-prolific_id, -n, -N) %>% distinct() %>% 
  mutate(response=as_factor(response)) %>% 
  filter(ratio>0)

df %>% 
  ggplot(aes(y=response, x=ratio)) +
  geom_bar(aes(fill=id), stat="identity") +
  theme_bw(base_size=18) +
  theme(legend.position = "none") +
  facet_wrap(~id)
```



```{r}
df.production.means = DATA$production %>% filter(id != "ind2") %>%
  dplyr::select(response, prolific_id, id) %>% 
  group_by(prolific_id,response) %>% 
  mutate(n=n()) %>% group_by(prolific_id) %>% mutate(N=n(), ratio=n/N) %>%
  arrange(desc(ratio)) %>% distinct() %>%
  mutate(response=as.factor(response))

# also note time spent
df = left_join(df.production.means,
               DATA$info %>% dplyr::select(prolific_id, timeSpent), 
               by=c("prolific_id")) %>% 
  mutate(timeSpent = round(timeSpent, 2), 
         utterance = as.character(response)) %>% 
  chunk_utterances() %>% rename(utt_type = utterance)

df$subj = df %>% group_by(prolific_id) %>% group_indices()
p  = df %>% group_by(subj) %>% 
  dplyr::select(prolific_id, subj, response, n, timeSpent, utt_type) %>% distinct() %>% 
  ggplot() +
  geom_bar(aes(y = response, x = n, fill = utt_type), stat = "identity") +
  # geom_text(aes(x = 9, y = "if green does not fall blue falls", label=timeSpent), color="red") + 
  theme_bw(base_size=18) +
  facet_wrap(~subj, labeller = label_both) + 
  theme(legend.position = "top") +
  scale_fill_discrete(name = "utterance type") + 
  labs(x = "count") +
  ggtitle("utterance frequencies per participant")
  
ggsave(paste(DATA$plot_dir, "utterance-frequencies.png", sep = FS),
       p, width=18, height=35)
```

```{r, utt-frquencies and time}
# participants who choose <= 3 different utterances AND whose total time spent
# was less than 20 minutes
df.sum = df %>%
  dplyr::select(response, prolific_id, subj, timeSpent) %>% distinct() %>%
  group_by(prolific_id) %>% mutate(n.utt = n()) %>%
  dplyr::select(-response) %>% distinct()

df.sum %>% filter(n.utt <= 3)

out.freq_time = df.sum %>% 
  filter(n.utt <= 3 & timeSpent < 20) 
out.freq_time

# remove all trials for these participants
df.out = out.freq_time %>% 
  dplyr::select(prolific_id) %>%
  add_column(id = rep(list(TRIALS), nrow(out.freq_time))) %>%
  unnest(c(id)) %>% 
  group_by(prolific_id)
```

# Participants' slider rating for u in task 1 is 0 but u is produced in task 2

```{r}
DATA$joint.orig %>% filter(!is.na(human_exp2) & human_exp1 == 0)
```

Data Quality 

```{r}
dat.quality = readRDS(paste(result_dir, "test-data-prior-quality.rds", sep = FS))
quality.means = dat.quality %>% arrange(desc(mean.comparator)) %>%
  distinct_at(vars(c(comparator)), .keep_all = TRUE) %>% 
  dplyr::select(-id)

p = quality.means %>% 
  ggplot(aes(x=mean.comparator)) +
  geom_density() +
  geom_jitter(aes(y=0, color=comparator), width=0, height=0.2) +
  ggtitle("avg data quality each proband across stimuli") +
  theme(legend.position="none")
p

out.quality = quality.means %>% filter(mean.comparator > 0.5) 
# remove
df.out =  out.quality %>% dplyr::select(mean.comparator, comparator) %>%
  rename(prolific_id=comparator) %>% 
  add_column(id=rep(list(TRIALS), nrow(out.quality))) %>%
  unnest(c(id)) %>% group_by(prolific_id) %>%
  filter(id != "ind2")
#write_csv(df.out, paste(DATA$result_dir, "out_by_quality.csv", sep=fs))
```

# Training Data

Slider-Choice Trials (used to check whether participants understood how sliders
are to be interpreted)

```{r}
data.train.sliders = dat.tidy$train.slider_choice
dat.sliders = data.train.sliders %>%
  mutate(correct = response == expected, .groups="drop_last")
  
# ratio correct per participant
dat.sl.participants = dat.sliders %>% group_by(prolific_id) %>%
  summarize(ratio_correct=sum(correct)/n(), .groups="drop_last")

p = dat.sl.participants %>% 
  ggplot(aes(x=0, y=ratio_correct)) +
  geom_boxplot(outlier.shape=NA) +
  geom_jitter(aes(color=prolific_id), shape=16, width=0.1, height=0) +
  theme(legend.position = "none")
p
dat.sl.participants %>% group_by(ratio_correct) %>% dplyr::count()

# ratio correct per id (difficulty slider-choice trials)
df.sliders = dat.sliders %>% group_by(id) %>% 
  summarize(ratio_correct = sum(correct) / n(), .groups="drop_last") %>%
  arrange(desc(ratio_correct)) %>%
  mutate(id = as_factor(id))
  
df.sliders %>%
  ggplot(aes(y=id, x=ratio_correct)) +
  geom_point() +
  labs(x="ratio participants who gave correct response")
```  




